name: Deploy App Server

on:
  workflow_run:
    workflows: ["Deploy DB Server"]
    types:
      - completed
    branches:
      - main

env:
  DOCKER_IMAGE: ${{ secrets.DOCKER_USERNAME }}/server
  DEPLOY_DIR: /opt/server
  HEALTH_CHECK_URL: https://api.heyxiaoli.com

jobs:
  deploy-app:
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Verify required files
        run: |
          for file in docker-compose.yml nginx.conf alembic.ini alembic/env.py script/initial_data.py; do
            [ -f "$file" ] || { echo "‚ùå Missing: $file"; exit 1; }
          done
          echo "‚úÖ All required files verified"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
          registry: docker.io

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile
          push: true
          tags: |
            ${{ env.DOCKER_IMAGE }}:latest
            ${{ env.DOCKER_IMAGE }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Generate .env.production file
        run: |
          mkdir -p secret
          echo "${{ secrets.ENV_PRODUCTION_FILE }}" > secret/.env.production
          [ -s secret/.env.production ] || { echo "‚ùå .env.production is empty"; exit 1; }

      - name: Upload files to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.APP_SERVER_IP }}
          username: ubuntu
          key: ${{ secrets.APP_SSH_KEY }}
          source: "docker-compose.yml,nginx.conf,secret/.env.production,script/setup-docker.sh,script/initial_data.py,alembic,alembic.ini"
          target: "/tmp/deploy-${{ github.run_id }}/"
          timeout: 300s

      - name: Deploy and start containers
        uses: appleboy/ssh-action@v0.1.8
        with:
          host: ${{ secrets.APP_SERVER_IP }}
          username: ubuntu
          key: ${{ secrets.APP_SSH_KEY }}
          command_timeout: 15m
          script: |
            set -e
            DEPLOY_TMP="/tmp/deploy-${{ github.run_id }}"
            DEPLOY_DIR="${{ env.DEPLOY_DIR }}"

            # Setup Docker if needed
            if [ -f "$DEPLOY_TMP/script/setup-docker.sh" ]; then
              chmod +x "$DEPLOY_TMP/script/setup-docker.sh"
              bash "$DEPLOY_TMP/script/setup-docker.sh"
            fi

            # Find .env.production
            ENV_FILE="$DEPLOY_TMP/secret/.env.production"
            [ -f "$ENV_FILE" ] || ENV_FILE="$DEPLOY_TMP/.env.production"
            [ -f "$ENV_FILE" ] || { echo "‚ùå .env.production not found"; exit 1; }

            # Backup existing deployment
            if [ -d "$DEPLOY_DIR" ]; then
              BACKUP_DIR="/opt/backups/server-$(date +%Y%m%d-%H%M%S)"
              sudo mkdir -p "$(dirname "$BACKUP_DIR")"
              sudo cp -r "$DEPLOY_DIR"/* "$BACKUP_DIR/" 2>/dev/null || true
              sudo ls -dt /opt/backups/server-* 2>/dev/null | tail -n +6 | xargs -r sudo rm -rf 2>/dev/null || true
            fi

            # Create directories and deploy files
            sudo mkdir -p "$DEPLOY_DIR"/{secret,alembic/versions,logs}
            sudo cp "$DEPLOY_TMP/docker-compose.yml" "$DEPLOY_DIR/"
            sudo cp "$DEPLOY_TMP/nginx.conf" "$DEPLOY_DIR/"
            sudo cp "$ENV_FILE" "$DEPLOY_DIR/secret/.env.production"
            sudo cp "$DEPLOY_TMP/alembic.ini" "$DEPLOY_DIR/"
            [ -f "$DEPLOY_TMP/script/initial_data.py" ] && sudo cp "$DEPLOY_TMP/script/initial_data.py" "$DEPLOY_DIR/"

            # Deploy alembic files
            if [ -d "$DEPLOY_TMP/alembic" ]; then
              sudo cp -r "$DEPLOY_TMP/alembic"/* "$DEPLOY_DIR/alembic/" || { echo "‚ùå Failed to copy alembic files"; exit 1; }
              echo "‚úÖ Alembic files deployed"
            else
              echo "‚ö†Ô∏è  No alembic directory found"
            fi

            # Set permissions
            sudo chmod 600 "$DEPLOY_DIR/secret/.env.production"
            sudo chown -R ubuntu:ubuntu "$DEPLOY_DIR"
            sudo rm -rf "$DEPLOY_TMP"

            # Pull and start containers
            echo "${{ secrets.DOCKER_PASSWORD }}" | sudo docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin
            sudo docker compose -f "$DEPLOY_DIR/docker-compose.yml" pull || sudo docker-compose -f "$DEPLOY_DIR/docker-compose.yml" pull
            sudo docker compose -f "$DEPLOY_DIR/docker-compose.yml" down --timeout 30 || true
            sudo docker image prune -f || true
            sudo docker compose -f "$DEPLOY_DIR/docker-compose.yml" up -d || sudo docker-compose -f "$DEPLOY_DIR/docker-compose.yml" up -d

            # Wait for containers
            for i in {1..30}; do
              SERVER_STATUS=$(sudo docker inspect --format='{{.State.Status}}' server 2>/dev/null || echo "not_found")
              NGINX_STATUS=$(sudo docker inspect --format='{{.State.Status}}' nginx 2>/dev/null || echo "not_found")
              [ "$SERVER_STATUS" = "running" ] && [ "$NGINX_STATUS" = "running" ] && break
              [ "$i" -eq 30 ] && { echo "‚ùå Containers failed to start"; sudo docker logs --tail=50 server; exit 1; }
              sleep 2
            done
            echo "‚úÖ Containers started"

      - name: Run database migration
        uses: appleboy/ssh-action@v0.1.8
        with:
          host: ${{ secrets.APP_SERVER_IP }}
          username: ubuntu
          key: ${{ secrets.APP_SSH_KEY }}
          command_timeout: 10m
          script: |
            set -e

            # Wait for database connection
            echo "‚è≥ Waiting for database..."
            for i in {1..30}; do
              sudo docker exec server /server/.venv/bin/alembic current 2>&1 | grep -qE "(revision|alembic_version|\(head\)|INFO)" && break
              [ "$i" -eq 30 ] && { echo "‚ùå Database connection timeout"; exit 1; }
              sleep 2
            done

            # Show current alembic status
            echo "üìä Current alembic status:"
            sudo docker exec server /server/.venv/bin/alembic current || true
            
            # Check current database version
            CURRENT_VERSION=$(sudo docker exec server /server/.venv/bin/alembic current 2>&1 | grep -oP '(?<=\(head\) )[a-f0-9]+' || echo "none")
            echo "üìå Current version: $CURRENT_VERSION"
            
            # If no version, check if database has tables
            if [ "$CURRENT_VERSION" = "none" ]; then
              echo "‚ö†Ô∏è  No version found, checking database state..."
              
              # Check if database has any tables (excluding alembic_version)
              TABLE_COUNT=$(sudo docker exec server /server/.venv/bin/python -c "
from sqlalchemy import create_engine, text
from app.core.config.settings import settings
import sys

url = settings.database.DATABASE_URL
if url.startswith('mysql+aiomysql://'):
    url = url.replace('mysql+aiomysql://', 'mysql+pymysql://')
elif url.startswith('mysql://'):
    url = url.replace('mysql://', 'mysql+pymysql://')

try:
    engine = create_engine(url)
    with engine.connect() as conn:
        result = conn.execute(text(\"SHOW TABLES\"))
        tables = [row[0] for row in result.fetchall() if row[0] != 'alembic_version']
        print(len(tables))
except Exception as e:
    print('0')
    sys.exit(0)
" 2>/dev/null || echo "0")
              
              echo "üìä Found $TABLE_COUNT table(s) in database (excluding alembic_version)"
              
              if [ "$TABLE_COUNT" -gt 0 ]; then
                echo "‚ö†Ô∏è  Database has tables but no version - marking as synced..."
                # Database has tables, generate migration to sync state
                if sudo docker exec server /server/.venv/bin/alembic revision --autogenerate -m "Sync existing schema $(date +%Y%m%d_%H%M%S)" 2>/dev/null; then
                  # Mark as head without running migration
                  sudo docker exec server /server/.venv/bin/alembic stamp head
                  echo "‚úÖ Database marked as synced"
                  exit 0
                else
                  echo "‚ö†Ô∏è  Could not sync, will try fresh migration..."
                fi
              else
                echo "‚úÖ Fresh database, ready for initial migration"
              fi
            fi
            
            # Generate migration to detect changes (dry run)
            echo "üìù Checking for schema changes..."
            if ! sudo docker exec server /server/.venv/bin/alembic revision --autogenerate -m "Auto migration $(date +%Y%m%d_%H%M%S)"; then
              echo "‚ùå Failed to generate migration"
              echo "üìã Checking alembic logs..."
              sudo docker logs --tail=100 server
              exit 1
            fi
            
            # Find the generated migration file
            MIGRATION_FILE=$(sudo docker exec server find /server/alembic/versions -name "*.py" ! -name "__init__.py" -type f | head -1)
            
            if [ -z "$MIGRATION_FILE" ]; then
              echo "‚ùå No migration file generated!"
              exit 1
            fi
            
            echo "üìÑ Generated migration file: $MIGRATION_FILE"
            
            # Check if migration has actual changes (not just empty upgrade/downgrade)
            echo "üîç Analyzing migration content..."
            MIGRATION_CONTENT=$(sudo docker exec server cat "$MIGRATION_FILE")
            
            # Count actual operations (op.create_table, op.add_column, etc.)
            HAS_CHANGES=$(echo "$MIGRATION_CONTENT" | grep -E "^\s+(op\.(create_table|drop_table|add_column|drop_column|alter_column|create_index|drop_index))" | wc -l)
            
            echo "üìä Detected $HAS_CHANGES schema operation(s)"
            
            if [ "$HAS_CHANGES" -gt 0 ]; then
              # Has actual schema changes - apply migration
              echo "‚ö†Ô∏è  Schema changes detected, applying migration..."
              echo "üìã Migration preview (first 50 lines):"
              sudo docker exec server head -50 "$MIGRATION_FILE"
              
              echo "üöÄ Applying migration..."
              if ! sudo docker exec server /server/.venv/bin/alembic upgrade head; then
                echo "‚ùå Failed to apply migration"
                echo "üìã Checking alembic logs..."
                sudo docker logs --tail=100 server
                exit 1
              fi
              
              echo "‚úÖ Migration applied successfully"
            else
              # No changes - just sync version
              echo "‚úÖ No schema changes detected"
              
              if [ "$CURRENT_VERSION" = "none" ]; then
                # Fresh database but migration is empty - this shouldn't happen
                echo "‚ö†Ô∏è  Fresh database but no tables to create - this is unexpected!"
                echo "üìã Migration content:"
                sudo docker exec server cat "$MIGRATION_FILE"
                exit 1
              else
                # Database already up to date - mark as current version
                echo "üìå Database schema is already up to date"
                echo "üîÑ Updating version marker to latest migration..."
                sudo docker exec server /server/.venv/bin/alembic stamp head
              fi
            fi
            
            # Verify final status
            echo "‚úÖ Migration completed. Final status:"
            sudo docker exec server /server/.venv/bin/alembic current

      - name: Insert initial data
        uses: appleboy/ssh-action@v0.1.8
        with:
          host: ${{ secrets.APP_SERVER_IP }}
          username: ubuntu
          key: ${{ secrets.APP_SSH_KEY }}
          script: |
            set -e
            [ -f "${{ env.DEPLOY_DIR }}/initial_data.py" ] || exit 0
            sudo docker exec -e PYTHONPATH=/server -w /server server /server/.venv/bin/python /server/script/initial_data.py
            echo "‚úÖ Initial data inserted"

      - name: Health check
        uses: appleboy/ssh-action@v0.1.8
        with:
          host: ${{ secrets.APP_SERVER_IP }}
          username: ubuntu
          key: ${{ secrets.APP_SSH_KEY }}
          script: |
            set -e
            sleep 10
            for i in {1..6}; do
              HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "${{ env.HEALTH_CHECK_URL }}" 2>/dev/null || echo "000")
              [ "$HTTP_CODE" = "200" ] && { echo "‚úÖ Health check passed"; exit 0; }
              echo "Waiting... ($i/6) - HTTP $HTTP_CODE"
              sleep 5
            done
            echo "‚ùå Health check failed"
            sudo docker logs --tail=50 server
            exit 1

      - name: Cleanup
        if: always()
        run: rm -rf secret/
